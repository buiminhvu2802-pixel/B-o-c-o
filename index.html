<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Dash Pro - Local Intelligence</title>
    
    <link rel="icon" type="image/png" href="./MVu.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 200; flex-direction: column; align-items: center; justify-content: center; }
        .dark #loading-overlay { background: rgba(11,17,32,0.8); }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .month-select { padding: 6px 12px; border-radius: 10px; border: 1px solid #e2e8f0; font-size: 13px; font-weight: 600; cursor: pointer; outline: none; }
        .dark .month-select { background: #1e293b; border-color: #334155; color: white; }
        
        /* Form Styles */
        .form-container-custom { background-color: transparent; width: 100%; border-radius: 12px; padding: 10px; }
        .form-group-custom { margin-bottom: 20px; }
        .form-group-custom label { display: block; margin-bottom: 8px; font-weight: 500; color: #444; font-size: 15px; }
        .dark .form-group-custom label { color: #cbd5e1; }
        .input-with-icon { position: relative; }
        .input-with-icon i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #888; pointer-events: none; }
        .custom-input-box { width: 100%; padding: 12px 15px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; outline: none; transition: all 0.2s; background-color: #fff; color: #333; }
        .dark .custom-input-box { background-color: #1e293b; border-color: #334155; color: #fff; }
        .custom-input-box:focus { border-color: #2563eb; }
        .upload-area-custom { border: 1px solid #e0e0e0; background-color: #fff; padding: 15px; border-radius: 8px; }
        .dark .upload-area-custom { background-color: #1e293b; border-color: #334155; }
        .upload-box-custom { background-color: #f8fafc; border: 1px dashed #ccc; border-radius: 6px; padding: 40px 20px; text-align: center; color: #666; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .dark .upload-box-custom { background-color: #0f172a; border-color: #475569; color: #94a3b8; }
        .upload-btn-custom { display: inline-flex; align-items: center; gap: 5px; color: #2563eb; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        .active-chan { background-color: #2563eb !important; color: white !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        /* Chat Animation */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- NEW SEARCH STYLES --- */
        .sidebar-search-container { position: relative; padding: 0 20px 20px 20px; border-bottom: 1px solid #1e293b; }
        .sidebar-search-input { width: 100%; background: #1e293b; border: 1px solid #334155; padding: 10px 10px 10px 35px; border-radius: 10px; color: white; font-size: 13px; outline: none; transition: border-color 0.2s; }
        .sidebar-search-input:focus { border-color: #3b82f6; }
        .sidebar-search-icon { position: absolute; left: 30px; top: 10px; font-size: 18px; color: #94a3b8; pointer-events: none; }
        
        #global-search-results { display: none; position: absolute; top: 100%; left: 10px; right: 10px; background: #0f172a; border: 1px solid #334155; border-radius: 12px; max-height: 300px; overflow-y: auto; z-index: 100; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); margin-top: -15px; }
        .search-result-item { padding: 10px; border-bottom: 1px solid #1e293b; cursor: pointer; transition: background 0.2s; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: #1e293b; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-[#0B1120] text-slate-900 dark:text-slate-100 min-h-screen">

    <div id="loading-overlay"><div class="spinner"></div><p class="mt-4 font-bold text-blue-600">Đang xử lý dữ liệu...</p></div>

    <div id="login-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center border border-white/10">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto flex items-center justify-center text-white mb-6 shadow-xl shadow-blue-600/30">
                <span class="material-symbols-outlined text-4xl">insights</span>
            </div>
            <h2 class="text-2xl font-black mb-2 dark:text-white">Marketing Dash</h2>
            <input type="password" id="pass-input" class="w-full p-4 bg-slate-100 dark:bg-slate-700 rounded-2xl border-none outline-none mb-4 text-center font-bold tracking-widest text-lg" placeholder="••••••">
            <button onclick="handleLogin()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black hover:bg-blue-700 transition-all">Truy cập Dashboard</button>
        </div>
    </div>

    <div id="main-app" class="hidden flex flex-col min-h-screen">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>

        <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-[#0F172A] text-white z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col border-r border-slate-800">
            <div class="p-6 flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center shadow-lg"><span class="material-symbols-outlined text-xl">insights</span></div>
                <div><h1 class="text-lg font-bold leading-tight">Marketing Dash</h1><p class="text-xs text-slate-400 font-medium italic">Campaign View</p></div>
            </div>

            <div class="mt-2 sidebar-search-container">
                <span class="material-symbols-outlined sidebar-search-icon">search</span>
                <input type="text" id="sidebar-search-input" 
                    class="sidebar-search-input" 
                    placeholder="Tìm Content hoặc Mã..." 
                    onkeydown="if(event.key === 'Enter') handleGlobalSearchAllMonths()">
                
                <div id="global-search-results"></div>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
                <button onclick="router.navigate('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3.5 px-3.5 py-3 rounded-xl transition-all"><span class="material-symbols-outlined text-[22px]">dashboard</span><span class="text-sm font-medium">Performance Dash</span></button>
                <button onclick="router.navigate('platform')" id="nav-platform" class="nav-item w-full flex items-center gap-3.5 px-3.5 py-3 rounded-xl transition-all"><span class="material-symbols-outlined text-[22px]">layers</span><span class="text-sm font-medium">Platform Detail</span></button>
                <button onclick="router.navigate('input')" id="nav-input" class="nav-item w-full flex items-center gap-3.5 px-3.5 py-3 rounded-xl transition-all"><span class="material-symbols-outlined text-[22px]">add_task</span><span class="text-sm font-medium">Input Data Content</span></button>
                <button onclick="router.navigate('ai')" id="nav-ai" class="nav-item w-full flex items-center gap-3.5 px-3.5 py-3 rounded-xl transition-all text-emerald-400 hover:bg-slate-800"><span class="material-symbols-outlined text-[22px]">psychology</span><span class="text-sm font-medium">Data Assistant</span></button>
            </nav>
            <div class="p-4 border-t border-slate-800 bg-slate-900/50">
                <button onclick="handleLogout()" class="w-full flex items-center gap-3 p-3 rounded-xl text-red-400"><span class="material-symbols-outlined">logout</span><span class="text-sm font-bold uppercase tracking-widest">Đăng xuất</span></button>
            </div>
        </aside>

        <header class="sticky top-0 z-30 bg-white/80 dark:bg-[#0B1120]/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 px-6 py-4 lg:ml-72 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><span class="material-symbols-outlined">menu</span></button>
                <h2 id="page-title" class="font-bold text-slate-900 dark:text-white">Performance Overview</h2>
            </div>
            <div class="flex items-center gap-3">
                <select id="month-selector" class="month-select" onchange="changeMonth()">
                    <option disabled selected>Đang tải tháng...</option>
                </select>
                <button onclick="toggleTheme()" class="p-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 transition-all"><span class="material-symbols-outlined text-xl" id="theme-icon">light_mode</span></button>
            </div>
        </header>

        <main id="viewport" class="lg:ml-72 p-6 max-w-7xl mx-auto w-full flex-1"></main>
    </div>

    <script>
        // ==========================================
        // KHÔNG CÒN SỬ DỤNG API KEY NỮA
        // ==========================================
        const SHEET_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwi6C6Ko9KSKrIjS4NsNgEjzzxPH9kUq45sPs1qtagSLsVIhTU40RJvHGmCOhZCGjrN3A/exec"; 
        
        const now = new Date();
        const initMM = ("0" + (now.getMonth() + 1)).slice(-2);
        const initYY = now.getFullYear().toString().slice(-2);
        let selectedMonth = initMM + "." + initYY; 

        let rawSheetData = [];
        let prevSheetData = []; 
        let currentPlatformDetail = ''; // Biến state mới cho Platform
        
        let stats = { 
            totalContent: 0, 
            totalViews: 0, 
            totalReach: 0, 
            viewsGrowth: 0, 
            reachGrowth: 0, 
            topEngageList: [], 
            contentPerf: [], 
            taskReps: [], 
            traffic: [], 
            topPosts: [] 
        };
        
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentChannelFilter = 'all'; 

        function getPreviousMonth(currentMonthStr) {
            let [mm, yy] = currentMonthStr.split('.').map(Number);
            let prevMm = mm - 1;
            let prevYy = yy;
            if (prevMm === 0) {
                prevMm = 12;
                prevYy = yy - 1;
            }
            return ("0" + prevMm).slice(-2) + "." + prevYy;
        }

        async function loadMonthSelector() {
            try {
                const res = await fetch(`${SHEET_SCRIPT_URL}?getSheets=true`);
                const sheetNames = await res.json();
                const selector = document.getElementById('month-selector');
                if (Array.isArray(sheetNames) && sheetNames.length > 0) {
                    selector.innerHTML = ''; 
                    sheetNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name; option.textContent = name;
                        selector.appendChild(option);
                    });
                    selector.value = sheetNames.includes(selectedMonth) ? selectedMonth : sheetNames[0];
                    selectedMonth = selector.value;
                }
            } catch (e) { console.error("Lỗi tải tháng:", e); }
        }

        async function fetchSheetData() {
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const timestamp = new Date().getTime();
                const resCurrent = await fetch(`${SHEET_SCRIPT_URL}?month=${encodeURIComponent(selectedMonth)}&nocache=${timestamp}`);
                const dataCurrent = await resCurrent.json();
                rawSheetData = (Array.isArray(dataCurrent) && dataCurrent.length > 0) ? dataCurrent.filter(row => row["Content"] && row["Người thực hiện"]) : [];

                const prevMonthName = getPreviousMonth(selectedMonth);
                const resPrev = await fetch(`${SHEET_SCRIPT_URL}?month=${encodeURIComponent(prevMonthName)}&nocache=${timestamp}`);
                const dataPrev = await resPrev.json();
                prevSheetData = (Array.isArray(dataPrev) && dataPrev.length > 0) ? dataPrev.filter(row => row["Content"]) : [];

                processData();
                router.navigate('dashboard');
            } catch (e) {
                console.error("Fetch Error:", e); rawSheetData = []; prevSheetData = []; processData(); router.navigate('dashboard');
            } finally { document.getElementById('loading-overlay').style.display = 'none'; }
        }

        function changeMonth() { selectedMonth = document.getElementById('month-selector').value; fetchSheetData(); }

        function getChannelStyling(channelName) {
            const name = (channelName || "").toLowerCase();
            if (name.includes("facebook")) return { icon: '<i class="fa-brands fa-facebook"></i>', color: '#3B82F6', bg: 'bg-[#3B82F6]' };
            if (name.includes("tiktok")) return { icon: '<i class="fa-brands fa-tiktok"></i>', color: '#F87171', bg: 'bg-[#F87171]' };
            if (name.includes("youtube")) return { icon: '<i class="fa-brands fa-youtube"></i>', color: '#EF4444', bg: 'bg-[#EF4444]' };
            if (name.includes("instagram")) return { icon: '<i class="fa-brands fa-instagram"></i>', color: '#EC4899', bg: 'bg-[#EC4899]' };
            if (name.includes("thread")) return { icon: '<i class="fa-solid fa-at"></i>', color: '#111827', bg: 'bg-[#111827]' };
            if (name.includes("website")) return { icon: '<i class="fa-solid fa-globe"></i>', color: '#10B981', bg: 'bg-[#10B981]' };
            return { icon: '<i class="fa-solid fa-share-nodes"></i>', color: '#94a3b8', bg: 'bg-[#94a3b8]' };
        }

        function processData() {
            stats.totalContent = rawSheetData.length;
            stats.totalViews = 0; 
            stats.totalReach = 0; 

            const repsMap = {}; const viewMap = {}; const channelMap = {}; const typeMap = {};
            
            rawSheetData.forEach(row => {
                const views = parseInt(row["Lượt xem"]) || 0;
                const reach = parseInt(row["Reach"]) || parseInt(row["Số người tiếp cận"]) || 0; 
                
                stats.totalViews += views;
                stats.totalReach += reach;

                const r = row["Người thực hiện"];
                if (!repsMap[r]) repsMap[r] = { name: r, tasks: 0, done: 0, prog: 0, todo: 0 };
                repsMap[r].tasks++;
                if (row["Trạng thái"] === "Đã đăng") repsMap[r].done++;
                else if (row["Trạng thái"] === "Đã hoàn thành") repsMap[r].prog++;
                else repsMap[r].todo++;
                
                if(row["Kênh Social"]) channelMap[row["Kênh Social"]] = (channelMap[row["Kênh Social"]] || 0) + 1;
                if(row["Loại Content"]) typeMap[row["Loại Content"]] = (typeMap[row["Loại Content"]] || 0) + 1;
                viewMap[r] = (viewMap[r] || 0) + views;
            });

            let prevViews = 0;
            let prevReach = 0;
            prevSheetData.forEach(row => {
                prevViews += (parseInt(row["Lượt xem"]) || 0);
                prevReach += (parseInt(row["Reach"]) || parseInt(row["Số người tiếp cận"]) || 0);
            });

            stats.viewsGrowth = prevViews > 0 ? ((stats.totalViews - prevViews) / prevViews) * 100 : 100;
            stats.reachGrowth = prevReach > 0 ? ((stats.totalReach - prevReach) / prevReach) * 100 : 100;

            stats.taskReps = Object.values(repsMap).map(item => ({ ...item, done: (item.done / item.tasks)*100, prog: (item.prog / item.tasks)*100, todo: (item.todo / item.tasks)*100 }));
            
            const channelColors = ['#3B82F6', '#EF4444', '#111827', '#EC4899', '#10B981'];
            stats.traffic = Object.keys(channelMap).map((key, i) => ({ 
                name: key, 
                value: channelMap[key], 
                color: channelColors[i % channelColors.length] 
            }));

            stats.contentPerf = Object.keys(typeMap).map(key => ({ name: key, value: typeMap[key] }));
            
            const sortedReps = Object.keys(viewMap).sort((a,b) => viewMap[b] - viewMap[a]);
            stats.topEngageList = sortedReps.slice(0, 3).map(rep => ({ 
                name: rep, 
                views: viewMap[rep] || 0 
            }));

            const sortedByViews = [...rawSheetData].sort((a, b) => (parseInt(b["Lượt xem"]) || 0) - (parseInt(a["Lượt xem"]) || 0));
            stats.topPosts = sortedByViews.slice(0, 3).map(post => {
                let icon = 'article';
                if (post["Loại Content"] === 'Video') icon = 'play_circle';
                else if (post["Loại Content"] === 'Hình ảnh') icon = 'image';
                const style = getChannelStyling(post["Kênh Social"]);
                return { title: post["Content"], meta: `<span style="color:${style.color}">${style.icon}</span> • ${post["ID Post"] || 'N/A'}`, stats: post["Lượt xem"] || '0', icon: icon, bg: 'bg-blue-50 text-blue-600 dark:bg-blue-900/30' };
            });
        }

        function getDashboardHTML() {
            const emptyMessage = `<div class="p-10 text-center text-slate-400 italic">Tháng ${selectedMonth} chưa có dữ liệu bài viết</div>`;
            
            let topEngageHTML = '';
            if (stats.topEngageList && stats.topEngageList.length > 0) {
                topEngageHTML = stats.topEngageList.map((person, index) => {
                    let badgeColor = index === 0 ? 'bg-yellow-400' : (index === 1 ? 'bg-slate-300' : 'bg-orange-300');
                    return `
                    <div class="flex items-center gap-3 mb-3 last:mb-0">
                        <div class="w-8 h-8 rounded-full ${badgeColor} flex items-center justify-center font-bold text-white text-xs shadow-sm">${index + 1}</div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center"><p class="font-bold dark:text-white text-sm">${person.name}</p><p class="text-xs text-blue-600 font-bold">${person.views.toLocaleString()}</p></div>
                            <div class="w-full bg-slate-100 rounded-full h-1.5 mt-1 dark:bg-slate-700"><div class="bg-blue-500 h-1.5 rounded-full" style="width: ${index === 0 ? '100' : (person.views / stats.topEngageList[0].views * 100)}%"></div></div>
                        </div>
                    </div>`;
                }).join('');
            } else { topEngageHTML = '<p class="text-xs text-slate-400 italic">Chưa có dữ liệu</p>'; }

            const formatNum = (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
                return num.toLocaleString();
            };

            const renderGrowth = (percent) => {
                const isPositive = percent >= 0;
                const colorClass = isPositive ? 'text-emerald-500' : 'text-red-500';
                const bgClass = isPositive ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600';
                const icon = isPositive ? 'trending_up' : 'trending_down';
                const sign = isPositive ? '+' : '';
                return { html: `<p class="text-xs ${colorClass} font-bold mt-2">${sign}${percent.toFixed(1)}% vs last month</p>`, iconBg: bgClass, iconName: icon };
            };

            const viewsGrowthUI = renderGrowth(stats.viewsGrowth);
            const reachGrowthUI = renderGrowth(stats.reachGrowth);

            return `<div class="space-y-6 animate-in fade-in duration-500">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] border shadow-sm">
                        <div class="flex justify-between items-start">
                            <div><p class="text-sm font-bold text-slate-500 mb-1">Total Views</p><h3 class="text-4xl font-black dark:text-white">${formatNum(stats.totalViews)}</h3></div>
                            <div class="p-2 ${viewsGrowthUI.iconBg} rounded-full"><span class="material-symbols-outlined text-xl">${viewsGrowthUI.iconName}</span></div>
                        </div>
                        ${viewsGrowthUI.html}
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] border shadow-sm">
                        <div class="flex justify-between items-start">
                            <div><p class="text-sm font-bold text-slate-500 mb-1">Total Reach</p><h3 class="text-4xl font-black dark:text-white">${formatNum(stats.totalReach)}</h3></div>
                            <div class="p-2 ${reachGrowthUI.iconBg} rounded-full"><span class="material-symbols-outlined text-xl">${reachGrowthUI.iconName}</span></div>
                        </div>
                        ${reachGrowthUI.html}
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] border shadow-sm flex flex-col justify-center">
                        <p class="text-sm font-semibold text-red-500 mb-1 uppercase tracking-wider">Total Content (${selectedMonth})</p>
                        <h3 class="text-5xl font-black text-red-500 mb-2">${stats.totalContent}</h3>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] border shadow-sm">
                        <p class="text-xs font-bold text-slate-500 uppercase mb-4 tracking-wider">Top Engagement</p>
                        <div class="flex flex-col justify-center h-full">${topEngageHTML}</div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] border shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h3 class="font-bold dark:text-white">Content Performance</h3>
                        <div class="flex flex-wrap gap-2 bg-slate-100 dark:bg-slate-900 p-1 rounded-xl" id="channel-filter-container">
                            <button onclick="filterByChannel('all')" class="chan-filter-btn px-3 py-1.5 rounded-lg text-[11px] font-bold transition-all active-chan" data-chan="all">TẤT CẢ</button>
                            ${stats.traffic.map(chan => `
                                <button onclick="filterByChannel('${chan.name}')" class="chan-filter-btn px-3 py-1.5 rounded-lg text-[11px] font-bold transition-all text-slate-500" data-chan="${chan.name}">${chan.name.toUpperCase()}</button>
                            `).join('')}
                        </div>
                    </div>
                    <div id="performance-content-area" class="h-64">
                        ${stats.totalContent > 0 ? '<canvas id="barChart"></canvas>' : emptyMessage}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] border shadow-sm"><h3 class="font-bold mb-6 dark:text-white">Task Status by Rep</h3>
                        <div class="space-y-5">${stats.totalContent > 0 ? stats.taskReps.map(rep => {
                            const d = Math.round((rep.done*rep.tasks)/100), p = Math.round((rep.prog*rep.tasks)/100), t = Math.round((rep.todo*rep.tasks)/100);
                            return `<div><div class="flex justify-between text-xs mb-2 font-bold"><span class="dark:text-slate-300">${rep.name}</span><span class="text-slate-500">${rep.tasks} Tasks</span></div>
                            <div class="flex w-full h-3 rounded-full overflow-hidden bg-slate-100 dark:bg-slate-700 cursor-help" title="Đã đăng: ${d} | Hoàn thành: ${p} | Đã bỏ: ${t}">
                            <div class="bg-emerald-500 h-full transition-all" style="width: ${rep.done}%"></div><div class="bg-amber-500 h-full transition-all" style="width: ${rep.prog}%"></div><div class="bg-slate-400 h-full transition-all" style="width: ${rep.todo}%"></div></div></div>`;
                        }).join('') : emptyMessage}</div>
                        <div class="flex gap-4 justify-center mt-6 pt-4 border-t border-slate-50 dark:border-slate-700/50 text-[10px] font-bold text-slate-500">
                            <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> ĐÃ ĐĂNG</div>
                            <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-amber-500"></span> HOÀN THÀNH</div>
                            <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-slate-400"></span> ĐÃ BỎ</div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] border shadow-sm flex flex-col items-center">
                        <h3 class="font-bold mb-4 w-full dark:text-white text-center text-sm uppercase">Traffic by Channel</h3>
                        <div class="relative h-48 w-48">${stats.totalContent > 0 ? '<canvas id="pieChart"></canvas>' : emptyMessage}</div>
                        <div class="mt-4 flex flex-wrap justify-center gap-x-4 gap-y-2">
                            ${stats.traffic.map(chan => {
                                const style = getChannelStyling(chan.name);
                                return `<div class="flex items-center gap-1.5 text-[11px] font-bold" style="color:${chan.color}">${style.icon} <span>${chan.name.toUpperCase()}</span></div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 overflow-hidden"><div class="p-5 border-b flex justify-between items-center"><h3 class="text-base font-semibold dark:text-white">Top Performing Posts</h3></div>
                <div class="divide-y">${stats.totalContent > 0 ? stats.topPosts.map(post => `<div class="p-4 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors cursor-pointer group"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl flex items-center justify-center ${post.bg} dark:bg-slate-900/30 group-hover:scale-105 transition-transform"><span class="material-symbols-outlined">${post.icon}</span></div><div><p class="text-sm font-semibold dark:text-white truncate max-w-[150px] sm:max-w-xs">${post.title}</p><p class="text-xs text-slate-500 flex items-center gap-1.5">${post.meta}</p></div></div><div class="text-right"><p class="text-sm font-bold dark:text-white">${post.stats}</p><p class="text-[10px] text-slate-400 uppercase tracking-tight">views</p></div></div>`).join('') : emptyMessage}</div></div>
            </div>`;
        }

        function getAIInsightsHTML() {
            const viewGrowthDisplay = stats.viewsGrowth.toFixed(1);
            const viewGrowthColor = stats.viewsGrowth >= 0 ? "text-emerald-400" : "text-red-400";
            
            return `
            <div class="flex-1 px-4 pb-24 pt-6 max-w-4xl mx-auto space-y-8 animate-in slide-in-from-bottom-6 duration-700">
                <div class="text-center mb-10 mt-4">
                    <h2 class="text-3xl font-bold dark:text-white text-slate-900 tracking-tight leading-snug">Your Performance Story</h2>
                    <p class="text-lg text-gray-500 dark:text-gray-400 mt-2">Insights generated for ${selectedMonth} </p>
                </div>

                <div id="ai-chat-history" class="space-y-4 mb-8 hidden"></div>

                <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl border border-slate-200 dark:border-gray-800 relative overflow-hidden shadow-sm">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                    <p class="text-sm text-blue-600 font-semibold mb-3 uppercase tracking-wide">Key Trend</p>
                    <h3 class="text-2xl font-bold dark:text-white text-slate-900 mb-4 leading-relaxed">Engagement Overview</h3>
                    <p class="text-slate-600 dark:text-gray-300 leading-relaxed text-base">
                        Trong tháng ${selectedMonth}, tổng lượt xem của bạn đạt <span class="font-bold dark:text-white text-slate-900">${stats.totalViews.toLocaleString()}</span>. 
                        Tăng trưởng so với tháng trước là <span class="font-bold ${viewGrowthColor}">${viewGrowthDisplay}%</span>. 
                        Điều này cho thấy hiệu suất nội dung đang ${stats.viewsGrowth >= 0 ? 'đi đúng hướng và thu hút sự chú ý' : 'cần được tối ưu hóa lại để bắt kịp xu hướng'}.
                    </p>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <div class="bg-slate-50 dark:bg-gray-900 p-4 rounded-xl flex items-center gap-3">
                            <span class="material-symbols-outlined text-blue-600 text-3xl">visibility</span>
                            <div>
                                <p class="text-xs text-slate-500 dark:text-gray-400">Total Views</p>
                                <p class="text-lg font-bold dark:text-white text-slate-900">${(stats.totalViews/1000).toFixed(1)}K <span class="${viewGrowthColor} text-sm">${viewGrowthDisplay}%</span></p>
                            </div>
                        </div>
                        <div class="bg-slate-50 dark:bg-gray-900 p-4 rounded-xl flex items-center gap-3">
                            <span class="material-symbols-outlined text-emerald-500 text-3xl">groups</span>
                            <div>
                                <p class="text-xs text-slate-500 dark:text-gray-400">Total Reach</p>
                                <p class="text-lg font-bold dark:text-white text-slate-900">${(stats.totalReach/1000).toFixed(1)}K</p>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-[#0B1120]/90 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 p-4 z-40 lg:ml-72 transition-all">
                    <div class="max-w-2xl mx-auto flex items-center gap-3">
                        <input 
                            id="ai-input-field"
                            class="flex-1 bg-slate-100 dark:bg-gray-800 border border-slate-300 dark:border-gray-700 rounded-full py-3 px-5 dark:text-white text-slate-900 text-sm placeholder-slate-500 focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition-all outline-none" 
                            placeholder="Hỏi về hiệu suất của bạn (Ví dụ: Bài viết nào tốt nhất?)..." 
                            type="text" 
                            onkeydown="if(event.key === 'Enter') handleAIChat()"
                        />
                        <button onclick="handleAIChat()" class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-lg shadow-blue-600/30 hover:bg-blue-700 transition-colors flex-shrink-0">
                            <span class="material-symbols-outlined text-2xl">send</span>
                        </button>
                    </div>
                    <p class="text-center text-xs text-slate-400 mt-2">"Tháng này ai làm việc hiệu quả nhất?"</p>
                </div>
            </div>
            `;
        }
        
        // ==========================================
        // 4. PLATFORM DETAILS HTML (MỚI)
        // ==========================================

        function getPlatformDetailsHTML() {
            return `
            <div id="platform-view" class="px-4 pb-6 pt-2 w-full animate-in fade-in duration-500">
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-3 px-1">
                        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Select Platform</p>
                    </div>
                    <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2" id="platform-selector-container">
                        </div>
                </div>

                <div class="flex flex-col gap-6 mb-8">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div id="plat-header-icon" class="w-14 h-14 rounded-2xl shadow-lg flex items-center justify-center text-white transition-colors">
                                <span class="material-symbols-outlined text-3xl">social_leaderboard</span>
                            </div>
                            <div>
                                <h2 id="plat-header-name" class="text-2xl font-bold dark:text-white text-slate-900 tracking-tight">Loading...</h2>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                                    <p class="text-xs text-gray-400 font-medium">Data synced from Sheet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-200 dark:border-gray-800 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="material-symbols-outlined text-4xl dark:text-white">visibility</span></div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-1">Total Views</p>
                        <h3 id="plat-kpi-views" class="text-2xl font-bold dark:text-white text-slate-900">...</h3>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-200 dark:border-gray-800 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="material-symbols-outlined text-4xl dark:text-white">groups</span></div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-1">Total Reach</p>
                        <h3 id="plat-kpi-reach" class="text-2xl font-bold dark:text-white text-slate-900">...</h3>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-200 dark:border-gray-800 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="material-symbols-outlined text-4xl dark:text-white">article</span></div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-1">Total Posts</p>
                        <h3 id="plat-kpi-posts" class="text-2xl font-bold dark:text-white text-slate-900">...</h3>
                    </div>
                     <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-200 dark:border-gray-800 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="material-symbols-outlined text-4xl dark:text-white">avg_pace</span></div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-1">Avg Views/Post</p>
                        <h3 id="plat-kpi-avg" class="text-2xl font-bold dark:text-white text-slate-900">...</h3>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-200 dark:border-gray-800 mb-6 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-lg font-bold dark:text-white text-slate-900">Performance Trends</h3>
                            <div class="flex items-center gap-3 mt-2">
                                <div class="flex items-center gap-1.5 text-[10px] text-gray-400"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Views</div>
                                <div class="flex items-center gap-1.5 text-[10px] text-gray-400"><span class="w-2 h-2 rounded-full bg-amber-500"></span> Reach</div>
                            </div>
                        </div>
                    </div>
                    <div class="h-64 w-full">
                         <canvas id="platformTrendChart"></canvas>
                    </div>
                </div>


                <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-200 dark:border-gray-800 overflow-hidden">
                    <div class="p-5 border-b border-slate-200 dark:border-gray-800 flex justify-between items-center">
                        <h3 class="text-base font-semibold dark:text-white text-slate-900">Top Content</h3>
                    </div>
                    <div class="divide-y divide-slate-100 dark:divide-gray-800" id="platform-top-content">
                        </div>
                </div>
            </div>
            `;
        }

        // ==========================================
        // 5. PLATFORM LOGIC & CHARTS
        // ==========================================
        
        function initPlatformPage() {
            // 1. Render Selector Buttons
            const container = document.getElementById('platform-selector-container');
            if(!container) return; // Not on page

            // Get unique channels
            const channels = stats.traffic.map(t => t.name);
            if(channels.length === 0) {
                 container.innerHTML = '<p class="text-sm text-slate-400">Chưa có dữ liệu kênh</p>';
                 return;
            }

            // Set default if not set
            if(!currentPlatformDetail && channels.length > 0) currentPlatformDetail = channels[0];

            container.innerHTML = channels.map(chan => {
                const style = getChannelStyling(chan);
                const isActive = chan === currentPlatformDetail;
                const activeClass = isActive ? `ring-2 ring-offset-2 ring-offset-slate-900 ring-${style.color.replace('#', '')}` : 'opacity-70 hover:opacity-100';
                return `
                <button onclick="switchPlatform('${chan}')" class="flex items-center gap-2 pl-2 pr-4 py-2 ${style.bg} text-white rounded-full shadow-lg transition-all flex-shrink-0 ${activeClass}">
                    <div class="w-7 h-7 rounded-full bg-white/20 flex items-center justify-center">
                        ${style.icon}
                    </div>
                    <span class="font-semibold text-sm">${chan}</span>
                </button>`;
            }).join('');

            updatePlatformView();
        }

        function switchPlatform(platformName) {
            currentPlatformDetail = platformName;
            initPlatformPage(); // Re-render buttons to update active state
        }

        function updatePlatformView() {
            // Filter Data for current platform
            const style = getChannelStyling(currentPlatformDetail);
            const platData = rawSheetData.filter(row => {
                const c = row["Kênh Social"] ? row["Kênh Social"].charAt(0).toUpperCase() + row["Kênh Social"].slice(1).toLowerCase() : "";
                return c === currentPlatformDetail;
            });

            // Update Header
            document.getElementById('plat-header-name').innerText = currentPlatformDetail;
            const headerIcon = document.getElementById('plat-header-icon');
            headerIcon.innerHTML = `<span class="material-symbols-outlined text-3xl">${style.icon.includes('facebook') ? 'facebook' : 'social_leaderboard'}</span>`; // Fallback icon logic simplification
            headerIcon.className = `w-14 h-14 rounded-2xl shadow-lg flex items-center justify-center text-white transition-colors ${style.bg}`;
            // If font awesome icon
            if(style.icon.includes('<i')) headerIcon.innerHTML = `<span class="text-3xl">${style.icon}</span>`;

            // Calculate KPIs
            let totalV = 0, totalR = 0;
            platData.forEach(r => {
                totalV += (parseInt(r["Lượt xem"])||0);
                totalR += (parseInt(r["Reach"])||parseInt(r["Số người tiếp cận"])||0);
            });
            const formatNum = (num) => { if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'; if (num >= 1000) return (num / 1000).toFixed(1) + 'k'; return num.toLocaleString(); };
            
            document.getElementById('plat-kpi-views').innerText = formatNum(totalV);
            document.getElementById('plat-kpi-reach').innerText = formatNum(totalR);
            document.getElementById('plat-kpi-posts').innerText = platData.length;
            document.getElementById('plat-kpi-avg').innerText = platData.length > 0 ? formatNum(Math.round(totalV / platData.length)) : 0;

            // Render Trend Chart
            renderPlatformTrendChart(platData, style.color);

            // Render Demographics (Mock)
            renderPlatformDemographics();

            // Render Top Content
            const sorted = [...platData].sort((a,b) => (parseInt(b["Lượt xem"])||0) - (parseInt(a["Lượt xem"])||0)).slice(0, 5);
            const listDiv = document.getElementById('platform-top-content');
            if(sorted.length === 0) listDiv.innerHTML = '<div class="p-5 text-center text-slate-500 italic">Chưa có bài viết nào</div>';
            else {
                listDiv.innerHTML = sorted.map(item => `
                 <div class="p-4 flex items-center gap-4 hover:bg-slate-50 dark:hover:bg-white/5 transition-colors">
                    <div class="w-12 h-12 rounded-lg flex-shrink-0 relative overflow-hidden flex items-center justify-center ${style.bg} bg-opacity-10 text-white">
                        <span class="material-symbols-outlined">article</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold dark:text-white text-slate-900 truncate">${item["Content"]}</p>
                        <p class="text-xs text-gray-400">ID: ${item["ID Post"] || 'N/A'}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold dark:text-white text-slate-900">${formatNum(parseInt(item["Lượt xem"])||0)}</p>
                        <p class="text-[10px] text-gray-400">Views</p>
                    </div>
                </div>
                `).join('');
            }
        }

        function renderPlatformTrendChart(data, color) {
            const ctx = document.getElementById('platformTrendChart');
            if(!ctx) return;
            
            // Group by Date (Assume "Ngày hoàn thành" format YYYY-MM-DD or similar)
            // Note: Data might be sparse. We will just take existing dates and sort them.
            const dateMap = {};
            data.forEach(row => {
                const d = row["Ngày hoàn thành"] || "Unknown";
                if(!dateMap[d]) dateMap[d] = { v: 0, r: 0 };
                dateMap[d].v += (parseInt(row["Lượt xem"])||0);
                dateMap[d].r += (parseInt(row["Reach"])||parseInt(row["Số người tiếp cận"])||0);
            });

            const labels = Object.keys(dateMap).sort();
            const vData = labels.map(d => dateMap[d].v);
            const rData = labels.map(d => dateMap[d].r);

            if(window.platTrendChart) window.platTrendChart.destroy();

            const isDark = currentTheme === 'dark';
            const gridColor = isDark ? '#334155' : '#e2e8f0';
            const textColor = isDark ? '#94a3b8' : '#64748b';

            window.platTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Views', data: vData, borderColor: color, backgroundColor: color + '33', fill: true, tension: 0.4 },
                        { label: 'Reach', data: rData, borderColor: '#F59E0B', backgroundColor: '#F59E0B33', fill: true, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: textColor } },
                        y: { grid: { color: gridColor }, ticks: { color: textColor } }
                    }
                }
            });
        }

        function renderPlatformDemographics() {
            // Mock Data as per request style
            const genderCtx = document.getElementById('platformGenderChart');
            const ageCtx = document.getElementById('platformAgeChart');
            if(!genderCtx || !ageCtx) return;

            if(window.platGenderChart) window.platGenderChart.destroy();
            if(window.platAgeChart) window.platAgeChart.destroy();

            window.platGenderChart = new Chart(genderCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Male', 'Female', 'Other'],
                    datasets: [{ data: [45, 52, 3], backgroundColor: ['#1877F2', '#8B5CF6', '#94A3B8'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 10 } } }, cutout: '70%' }
            });

            window.platAgeChart = new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: ['18-24', '25-34', '35-44', '45+'],
                    datasets: [{ data: [25, 45, 20, 10], backgroundColor: '#1877F2', borderRadius: 4 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false }, ticks: { color: '#94a3b8' } }, y: { display: false } }
                }
            });
        }

        // ==========================================
        // CẤU HÌNH OPENAI (REAL AI)
        // ==========================================
        // KHUYẾN CÁO: Chỉ dùng cách này để chạy thử nghiệm cá nhân (Local).
        // Nếu đưa lên mạng public, bạn cần ẩn Key này ở phía Server (Backend).
        const OPENAI_API_KEY = "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"; 
        
        async function handleAIChat() {
            const inputField = document.getElementById('ai-input-field');
            const chatHistory = document.getElementById('ai-chat-history');
            const question = inputField.value.trim();
            
            if (!question) return;

            // 1. Hiển thị câu hỏi của User
            chatHistory.classList.remove('hidden');
            chatHistory.innerHTML += `
                <div class="flex justify-end animate-in slide-in-from-right-2 fade-in">
                    <div class="bg-blue-600 text-white px-5 py-3 rounded-2xl rounded-tr-none max-w-[80%] shadow-md text-sm">
                        ${question}
                    </div>
                </div>
            `;
            inputField.value = '';
            
            // 2. Hiển thị Loading
            const loadingId = 'loading-' + Date.now();
            chatHistory.innerHTML += `
                <div id="${loadingId}" class="flex justify-start animate-in slide-in-from-left-2 fade-in">
                    <div class="bg-white dark:bg-slate-700 text-slate-800 dark:text-white px-5 py-4 rounded-2xl rounded-tl-none border border-slate-200 dark:border-slate-600 shadow-sm flex gap-1">
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    </div>
                </div>
            `;
            chatHistory.scrollIntoView({ behavior: 'smooth', block: 'end' });

            // 3. GỌI API OPENAI THẬT
            try {
                const answer = await callOpenAI(question);
                
                // Xóa loading và hiển thị câu trả lời
                document.getElementById(loadingId).remove();
                
                // Format Markdown cơ bản sang HTML (nếu cần thiết, ở đây dùng text thuần có xuống dòng)
                const formattedAnswer = answer.replace(/\n/g, '<br>');

                chatHistory.innerHTML += `
                    <div class="flex justify-start animate-in slide-in-from-left-2 fade-in">
                        <div class="bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 px-5 py-4 rounded-2xl rounded-tl-none border border-slate-200 dark:border-slate-700 shadow-sm max-w-[90%] text-sm leading-relaxed">
                            <div class="flex items-center gap-2 mb-2 text-emerald-500 font-bold text-xs uppercase tracking-wider">
                                <span class="material-symbols-outlined text-sm">psychology</span> OpenAI Intelligence
                            </div>
                            ${formattedAnswer}
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById(loadingId).remove();
                chatHistory.innerHTML += `
                    <div class="flex justify-start text-red-500 text-sm italic">
                        Lỗi kết nối API: ${error.message}. Kiểm tra lại Key hoặc hạn mức tài khoản.
                    </div>
                `;
            }
            
            window.scrollTo(0, document.body.scrollHeight);
        }

async function callOpenAI(userQuestion) {
            // BƯỚC 1: TÌM KIẾM DỮ LIỆU LIÊN QUAN TRONG SHEET TRƯỚC
            // (Vì AI không thể đọc hết 1000 dòng, ta phải lọc ra những dòng có vẻ liên quan đến câu hỏi nhất)
            
            const lowerQuestion = userQuestion.toLowerCase();
            
            // Lọc ra các bài viết mà Tiêu đề hoặc ID có xuất hiện trong câu hỏi của người dùng
            const relatedPosts = rawSheetData.filter(row => {
                const content = (row["Content"] || "").toLowerCase();
                const id = (row["ID Post"] || "").toString().toLowerCase();
                const channel = (row["Kênh Social"] || "").toLowerCase();

                // Logic tìm kiếm:
                // 1. Nếu câu hỏi chứa ID bài viết
                if (id && id.length > 2 && lowerQuestion.includes(id)) return true;
                
                // 2. Nếu nội dung bài viết chứa từ khóa quan trọng trong câu hỏi
                // (Ví dụ: Câu hỏi "bài sbs thế nào", Content "Video SBS viral" -> Khớp chữ "sbs")
                // Ta tách tiêu đề bài viết thành các từ, nếu câu hỏi chứa từ đó thì lấy.
                // Để tránh nhiễu, chỉ lấy các từ có độ dài > 3 ký tự (bỏ qua 'là', 'của'...)
                
                // Cách đơn giản hơn: Kiểm tra xem Content của dòng đó có chứa từ nào trong câu hỏi không?
                // Tuy nhiên, để chính xác cho trường hợp "SBS", "Naked", ta check ngược lại:
                // Nếu User gõ "SBS", ta tìm xem row["Content"] có chứa "SBS" không.
                
                // Tách câu hỏi thành mảng từ khóa (bỏ từ ngắn)
                const questionKeywords = lowerQuestion.split(/\s+/).filter(w => w.length > 2);
                
                // Nếu bất kỳ từ khóa nào trong câu hỏi xuất hiện trong Content bài viết
                const hasKeyword = questionKeywords.some(kw => content.includes(kw));
                
                return hasKeyword;
            }).slice(0, 10); // Chỉ lấy tối đa 10 bài liên quan nhất để tiết kiệm token

            // BƯỚC 2: CHUẨN BỊ DỮ LIỆU NGỮ CẢNH (CONTEXT)
            
            // Format dữ liệu tìm được thành dạng chuỗi dễ đọc cho AI
            const searchContext = relatedPosts.length > 0 
                ? relatedPosts.map(p => `- [Kênh: ${p["Kênh Social"]} | ID: ${p["ID Post"]}] "${p["Content"]}": ${p["Lượt xem"]} views, ${p["Trạng thái"]}`).join('\n')
                : "Không tìm thấy bài viết cụ thể nào khớp với từ khóa.";

            const contextData = {
                month: selectedMonth,
                summary: {
                    totalViews: stats.totalViews,
                    totalReach: stats.totalReach,
                    growth: stats.viewsGrowth.toFixed(1) + "%",
                },
                topPerformers: stats.topEngageList.map(p => `${p.name} (${p.views} views)`).join(', '),
                trafficSource: stats.traffic.map(t => `${t.name}: ${t.value} bài`).join(', '),
                // Quan trọng: Gửi dữ liệu đã tìm kiếm được cho AI
                searchResults: searchContext 
            };

            const systemPrompt = `
                Bạn là trợ lý phân tích dữ liệu Marketing. Dữ liệu tháng ${selectedMonth}:
                
                1. TỔNG QUAN:
                - Views: ${contextData.summary.totalViews}
                - Reach: ${contextData.summary.totalReach}
                - Tăng trưởng: ${contextData.summary.growth}
                
                2. KẾT QUẢ TÌM KIẾM TỪ KHÓA CỦA NGƯỜI DÙNG TRONG DATA:
                ${contextData.searchResults}
                
                3. TOP NHÂN SỰ: ${contextData.topPerformers}
                
                NHIỆM VỤ:
                - Dựa vào mục (2) "KẾT QUẢ TÌM KIẾM" để trả lời chi tiết về các bài viết cụ thể (như SBS, Naked, mã ID...).
                - Nếu mục (2) có dữ liệu khớp, hãy phân tích view, trạng thái của nó.
                - Nếu không thấy trong mục (2), hãy báo là không tìm thấy trong dữ liệu tháng này.
                - Trả lời ngắn gọn, format đẹp (dùng markdown, xuống dòng).
            `;

            // BƯỚC 3: GỌI API
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userQuestion }
                    ],
                    temperature: 0.5, // Giảm độ sáng tạo để AI tập trung vào số liệu chính xác
                    max_tokens: 600
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || 'Lỗi API');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function getInputFormHTML() {
            return `
            <div class="bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] border shadow-sm animate-in slide-in-from-bottom-4">
                <div class="form-container-custom">
                    <h1 class="text-2xl font-black mb-8 text-center uppercase dark:text-white">Form nhập content</h1>
                    <form id="content-form-real">
                        <div class="form-group-custom"><label class="dark:text-slate-300 font-semibold">Content</label><input type="text" name="Content" class="custom-input-box" placeholder="Nhập tiêu đề hoặc nội dung..." required></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group-custom"><label class="dark:text-slate-300 font-semibold">Loại Content</label>
                                <select name="Loại Content" class="custom-input-box" required>
                                    <option value="" disabled selected hidden>Vui lòng lựa chọn</option>
                                    <option value="Bài viết khoa học">Bài viết khoa học</option><option value="Bài viết công nghệ">Bài viết công nghệ</option><option value="Kết quả điều trị">Kết quả điều trị</option><option value="Tin tức">Tin tức</option><option value="Chuyển giao">Chuyển giao</option><option value="Sự kiện">Sự kiện</option><option value="Ads">Ads</option><option value="Normal">Normal</option><option value="Share">Share</option>
                                </select>
                            </div>
                            <div class="form-group-custom"><label class="dark:text-slate-300 font-semibold">Kênh social</label>
                                <select name="Kênh Social" class="custom-input-box" required>
                                    <option value="" disabled selected hidden>Vui lòng lựa chọn</option>
                                    <option value="Facebook">Facebook</option><option value="Tiktok">Tiktok</option><option value="Youtube">Youtube</option><option value="Instagram">Instagram</option><option value="Thread">Thread</option><option value="Website">Website</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group-custom"><label class="dark:text-slate-300 font-semibold">Link Kênh</label>
                            <div class="input-with-icon"><input type="text" name="Link Kênh" class="custom-input-box" placeholder="Dán link bài viết hoặc video"><i class="fa-solid fa-link"></i></div>
                        </div>
                        <div class="form-group-custom"><label class="dark:text-slate-300 font-semibold">File hình ảnh</label>
                            <div class="upload-area-custom"><input type="file" id="file-input-real" style="display: none;">
                                <div class="upload-box-custom" id="upload-trigger-real"><span id="file-name-real" class="text-sm">Dán hoặc kéo tệp tin vào đây</span><div class="upload-btn-custom"><i class="fa-solid fa-plus"></i> Tải lên tệp tin cục bộ</div></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group-custom"><label class="dark:text-slate-300 font-semibold">Trạng thái</label>
                                <select name="Trạng thái" id="status-select-real" class="custom-input-box" required>
                                    <option value="" disabled selected hidden>Vui lòng lựa chọn</option>
                                    <option value="Đã hoàn thành">Đã hoàn thành</option><option value="Đã đăng">Đã đăng</option><option value="Đã bỏ">Đã bỏ</option>
                                </select>
                            </div>
                            <div class="form-group-custom" id="id-post-container-real" style="display: none;"><label class="dark:text-slate-300 font-semibold">ID Post</label>
                                <div class="input-with-icon"><input type="text" name="ID Post" id="id-post-input-real" class="custom-input-box" placeholder="Nhập ID Post"><i class="fa-solid fa-hashtag"></i></div>
                            </div>
                        </div>
                        <div class="form-group-custom"><label class="dark:text-slate-300 font-semibold">Link tổng</label>
                            <div class="input-with-icon"><input type="text" name="Link tổng" class="custom-input-box" placeholder="Nhập link tổng..."><i class="fa-solid fa-link"></i></div>
                        </div>
                        <div class="form-group-custom"><label class="dark:text-slate-300 font-semibold">Người thực hiện</label>
                            <select name="Người thực hiện" class="custom-input-box" required>
                                <option value="" disabled selected hidden>Chọn thành viên</option>
                                <option value="Minh Vũ">Minh Vũ</option><option value="Minh Anh">Minh Anh</option><option value="Hoài Phương">Hoài Phương</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group-custom"><label class="dark:text-slate-300 font-semibold">Ngày hoàn thành</label><input type="date" name="Ngày hoàn thành" class="custom-input-box"></div>
                            <div class="form-group-custom"><label class="dark:text-slate-300 font-semibold">Người kiểm tra</label>
                                <select name="Người kiểm tra" class="custom-input-box" required>
                                    <option value="" disabled selected hidden>Chọn người kiểm tra</option>
                                    <option value="Sếp">Sếp</option><option value="Hoài Phương">Hoài Phương</option><option value="Minh Vũ">Minh Vũ</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold uppercase shadow-lg hover:bg-blue-700 transition-all mt-4">Gửi dữ liệu vào Sheet T12</button>
                    </form>
                </div>
            </div>`;
        }

        function setupFormLogic() {
            const form = document.getElementById('content-form-real'), fileInput = document.getElementById('file-input-real'), trigger = document.getElementById('upload-trigger-real'), fileName = document.getElementById('file-name-real'), statusSel = document.getElementById('status-select-real'), idCont = document.getElementById('id-post-container-real'), idInp = document.getElementById('id-post-input-real');
            if(!form) return;
            trigger.onclick = () => fileInput.click();
            fileInput.onchange = () => { if (fileInput.files.length > 0) { fileName.textContent = "Đã chọn: " + fileInput.files[0].name; fileName.classList.add('text-blue-600', 'font-bold'); } };
            statusSel.onchange = function() { idCont.style.display = (this.value === 'Đã đăng') ? 'block' : 'none'; if(this.value === 'Đã đăng') idInp.required = true; else idInp.required = false; };
            form.onsubmit = async (e) => {
                e.preventDefault(); document.getElementById('loading-overlay').style.display = 'flex';
                try {
                    const formData = new FormData(form); const dataObj = Object.fromEntries(formData.entries());
                    dataObj.month = "T12";
                    if (fileInput.files.length > 0) {
                        const file = fileInput.files[0], reader = new FileReader();
                        const base64 = await new Promise(res => { reader.onload = () => res(reader.result); reader.readAsDataURL(file); });
                        dataObj.fileData = base64.split(',')[1]; dataObj.fileName = file.name; dataObj.mimeType = file.type;
                    }
                    const res = await fetch(SHEET_SCRIPT_URL, { method: 'POST', body: JSON.stringify(dataObj) });
                    const result = await res.json();
                    if (result.result === 'success') { alert('Gửi thành công vào sheet T12!'); form.reset(); fileName.textContent = "Dán hoặc kéo tệp tin vào đây"; fileName.classList.remove('text-blue-600', 'font-bold'); idCont.style.display = 'none'; fetchSheetData(); }
                } catch (error) { alert('Lỗi gửi dữ liệu!'); } finally { document.getElementById('loading-overlay').style.display = 'none'; }
            };
        }

        function filterByChannel(channelName) {
            currentChannelFilter = channelName;
            const buttons = document.querySelectorAll('.chan-filter-btn');
            buttons.forEach(btn => { if(btn.getAttribute('data-chan') === channelName) btn.classList.add('active-chan'); else btn.classList.remove('active-chan'); });
            initCharts();
        }

        const router = {
            navigate: (page) => {
                const viewport = document.getElementById('viewport'), title = document.getElementById('page-title');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('bg-blue-600', 'text-white', 'shadow-lg'));
                const activeNav = document.getElementById('nav-' + page);
                if(activeNav) activeNav.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
                
                if (page === 'dashboard') { 
                    title.innerText = "Performance Overview"; 
                    viewport.innerHTML = getDashboardHTML(); 
                    initCharts(); 
                } else if (page === 'input') { 
                    title.innerText = "Content Entry Form"; 
                    viewport.innerHTML = getInputFormHTML(); 
                    setupFormLogic(); 
                } else if (page === 'ai') {
                    title.innerText = "Data Assistant";
                    viewport.innerHTML = getAIInsightsHTML();
                    window.scrollTo(0,0);
                } else if (page === 'platform') {
                    title.innerText = "Platform Deep Dive";
                    viewport.innerHTML = getPlatformDetailsHTML();
                    initPlatformPage();
                }
                
                if(window.innerWidth < 1024) toggleSidebar(false);
                window.scrollTo(0,0);
            }
        };

        function initCharts() {
            if(stats.totalContent === 0) return;
            const ctx = document.getElementById('barChart');
            if(!ctx) return;
            
            const isDark = currentTheme === 'dark';
            const tickColor = isDark ? '#94a3b8' : '#64748b';

            let labels, data, barColor;

            if (currentChannelFilter === 'all') {
                labels = stats.contentPerf.map(d => d.name);
                data = stats.contentPerf.map(d => d.value);
                barColor = '#10B981';
            } else {
                const filteredData = rawSheetData.filter(row => (row["Kênh Social"] || "").toLowerCase() === currentChannelFilter.toLowerCase());
                const typeCounts = {};
                filteredData.forEach(row => {
                    const type = row["Loại Content"] || "Chưa phân loại";
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });
                labels = Object.keys(typeCounts);
                data = Object.values(typeCounts);
                barColor = getChannelStyling(currentChannelFilter).color;
            }

            if (window.myBarChart) window.myBarChart.destroy();
            window.myBarChart = new Chart(ctx.getContext('2d'), { type: 'bar', data: { labels: labels, datasets: [{ label: 'Số lượng bài', data: data, backgroundColor: barColor, barThickness: 30, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: tickColor, stepSize: 1 } }, x: { ticks: { color: tickColor } } }, plugins: { legend: { display: false } } } });

            const pieCtx = document.getElementById('pieChart');
            if(!pieCtx) return;
            
            if (window.myPieChart) window.myPieChart.destroy();
            window.myPieChart = new Chart(pieCtx.getContext('2d'), { type: 'doughnut', data: { labels: stats.traffic.map(d => d.name), datasets: [{ data: stats.traffic.map(d => d.value), backgroundColor: stats.traffic.map(d => d.color) }] }, options: { cutout: '70%', plugins: { legend: { display: false } } } });
        }

        function handleLogin() { if (document.getElementById('pass-input').value === '123') { sessionStorage.setItem('isLogged', 'true'); initApp(); } else alert('Mật khẩu sai!'); }
        function handleLogout() { sessionStorage.removeItem('isLogged'); location.reload(); }
        function toggleTheme() { currentTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem('theme', currentTheme); applyTheme(); router.navigate('dashboard'); }
        function applyTheme() { document.documentElement.classList.toggle('dark', currentTheme === 'dark'); document.getElementById('theme-icon').innerText = currentTheme === 'dark' ? 'dark_mode' : 'light_mode'; }
        function toggleSidebar(force) { const sidebar = document.getElementById('sidebar'); sidebar.classList.toggle('-translate-x-full', force !== undefined ? !force : undefined); }
        async function initApp() { if (sessionStorage.getItem('isLogged')) { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden'); applyTheme(); await loadMonthSelector(); fetchSheetData(); } }
        window.onload = initApp;

        // ==========================================
        // GLOBAL SEARCH LOGIC (ADDED)
        // ==========================================
        let globalAllMonthsData = null; 

        // Hàm xử lý chính khi nhấn Enter
        async function handleGlobalSearchAllMonths() {
            const query = document.getElementById('sidebar-search-input').value.toLowerCase().trim();
            const resultsBox = document.getElementById('global-search-results');
            
            if (!query) {
                resultsBox.style.display = 'none';
                return;
            }

            // Hiển thị loading
            resultsBox.style.display = 'block';
            resultsBox.innerHTML = `
                <div class="p-4 text-center text-slate-400">
                    <div class="spinner w-6 h-6 border-2 border-blue-500 border-t-transparent mx-auto mb-2"></div>
                    <p class="text-xs">Đang quét toàn bộ dữ liệu các tháng...</p>
                </div>`;

            try {
                // 1. Nếu chưa có dữ liệu cache, tải toàn bộ từ Google Sheets
                if (!globalAllMonthsData) {
                    await fetchAllMonthsData();
                }

                // 2. Lọc dữ liệu: Tìm trong cột "Content" HOẶC "Mã Content"
                const results = globalAllMonthsData.filter(row => {
                    const content = (row["Content"] || "").toLowerCase();
                    // Lấy Mã Content, chuyển về chuỗi thường để so sánh
                    const maContent = (row["Mã Content"] || "").toString().toLowerCase(); 
                    
                    return content.includes(query) || maContent.includes(query);
                });

                // 3. Hiển thị kết quả
                if (results.length === 0) {
                    resultsBox.innerHTML = '<div class="p-4 text-center text-xs text-slate-400 italic">Không tìm thấy kết quả nào.</div>';
                } else {
                    resultsBox.innerHTML = results.map(item => {
                        const style = getChannelStyling(item["Kênh Social"]);
                        const link = item["Link tổng"] || "#";
                        const hasLink = link !== "#" && link.trim() !== "";
                        const maContentDisplay = item["Mã Content"] || 'N/A';
                        
                        return `
                        <div class="search-result-item" onclick="${hasLink ? `window.open('${link}', '_blank')` : ''}">
                            <div class="flex justify-between items-start gap-2">
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-bold text-white truncate">${item["Content"]}</p>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-[10px] px-1.5 py-0.5 rounded bg-slate-700 text-slate-300 border border-slate-600">Tháng ${item._sourceMonth}</span>
                                        <div class="flex items-center gap-1 text-[10px]" style="color:${style.color}">
                                            ${style.icon} <span>Mã: ${maContentDisplay}</span>
                                        </div>
                                    </div>
                                </div>
                                ${hasLink ? '<i class="fa-solid fa-external-link-alt text-slate-500 text-xs mt-1"></i>' : ''}
                            </div>
                        </div>`;
                    }).join('');
                }

            } catch (e) {
                console.error(e);
                resultsBox.innerHTML = '<div class="p-4 text-center text-xs text-red-400">Lỗi tải dữ liệu.</div>';
            }
        }

        // Hàm phụ trợ: Tải tất cả các Sheet (Tháng) về cùng lúc
        async function fetchAllMonthsData() {
            // Lấy danh sách tên các sheet (T12.23, T01.24...)
            const resSheets = await fetch(`${SHEET_SCRIPT_URL}?getSheets=true`);
            const sheetNames = await resSheets.json();
            
            if (!Array.isArray(sheetNames) || sheetNames.length === 0) {
                globalAllMonthsData = [];
                return;
            }

            // Tải song song (Parallel Fetching) để tăng tốc độ
            const fetchPromises = sheetNames.map(sheet => 
                fetch(`${SHEET_SCRIPT_URL}?month=${encodeURIComponent(sheet)}`)
                    .then(r => r.json())
                    .then(data => {
                        // Gán thêm tên tháng vào dòng dữ liệu để biết nguồn gốc
                        return data.map(row => ({...row, _sourceMonth: sheet}));
                    })
                    .catch(err => []) 
            );

            const allDataArrays = await Promise.all(fetchPromises);
            
            // Gộp tất cả mảng con thành 1 mảng lớn
            globalAllMonthsData = allDataArrays.flat().filter(row => row["Content"]);
        }

        // Đóng hộp tìm kiếm khi click ra ngoài
        document.addEventListener('click', function(event) {
            const box = document.getElementById('global-search-results');
            const input = document.getElementById('sidebar-search-input');
            if (box && input && !box.contains(event.target) && !input.contains(event.target)) {
                box.style.display = 'none';
            }
        });
    </script>
</body>
</html>